<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PourquoiVoter.fr — Paris 2026</title>
  <meta name="description" content="Comparez les programmes des candidats aux municipales de Paris 2026. Neutre et factuel." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #F7F6F2;
      --white: #FFFFFF;
      --ink: #111111;
      --ink-mid: #555555;
      --ink-light: #999999;
      --border: #E5E3DC;
      --navy: #0D1F3C;
      --accent: #FF4242;
      --shadow: 0 2px 12px rgba(0,0,0,0.07);
      --shadow-hover: 0 6px 24px rgba(0,0,0,0.12);
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--ink);
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      line-height: 1.6;
    }

    header {
      background: var(--navy);
      position: sticky;
      top: 0;
      z-index: 200;
    }

    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .logo-main {
      font-family: 'DM Serif Display', serif;
      font-size: 22px;
      color: white;
    }

    .logo-accent { color: var(--accent); }

    .logo-sub {
      font-size: 11px;
      font-weight: 400;
      color: rgba(255,255,255,0.4);
      margin-left: 12px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .header-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
    }

    .pill {
      font-size: 11px;
      font-weight: 500;
      padding: 3px 10px;
      border-radius: 20px;
      color: white;
      opacity: 0.9;
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 24px 140px;
    }

    .suggested-wrap { margin-bottom: 32px; }

    .section-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--ink-light);
      margin-bottom: 12px;
    }

    .suggested-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .suggested-btn {
      background: var(--white);
      border: 1.5px solid var(--border);
      border-radius: 24px;
      padding: 8px 16px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13.5px;
      color: var(--ink);
      cursor: pointer;
      transition: all 0.15s;
    }

    .suggested-btn:hover {
      border-color: var(--navy);
      background: var(--navy);
      color: white;
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    #conversation {
      display: flex;
      flex-direction: column;
      gap: 40px;
    }

    .user-message {
      display: flex;
      justify-content: flex-end;
      animation: fadeUp 0.2s ease;
    }

    .user-bubble {
      background: var(--navy);
      color: white;
      border-radius: 20px 20px 4px 20px;
      padding: 12px 20px;
      font-size: 15px;
      max-width: 600px;
      line-height: 1.5;
    }

    .assistant-message { animation: fadeUp 0.25s ease; }

    .response-intro {
      font-family: 'DM Serif Display', serif;
      font-size: 18px;
      color: var(--ink);
      margin-bottom: 20px;
      line-height: 1.5;
      max-width: 700px;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap: 14px;
      margin-bottom: 16px;
    }

    .candidate-card {
      background: var(--white);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: transform 0.15s, box-shadow 0.15s;
      display: flex;
      flex-direction: column;
    }

    .candidate-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .card-header {
      padding: 14px 16px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .card-name {
      font-size: 13.5px;
      font-weight: 700;
      color: white;
      line-height: 1.3;
    }

    .card-party {
      font-size: 11px;
      font-weight: 500;
      color: rgba(255,255,255,0.75);
    }

    .card-score-circle {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }

    .card-body {
      padding: 14px 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-highlight {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--ink-mid);
      padding: 4px 8px;
      background: var(--bg);
      border-radius: 4px;
      display: inline-block;
    }

    .card-position {
      font-size: 13px;
      color: var(--ink-mid);
      line-height: 1.55;
    }

    .card-indicators { margin-top: auto; padding-top: 10px; display: flex; flex-direction: column; gap: 6px; }

    .card-indicator-row { display: flex; flex-direction: column; gap: 2px; }

    .card-indicator-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--ink-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-stars { font-size: 12px; letter-spacing: 1px; }

    .card-indicator-detail {
      font-size: 11px;
      color: var(--ink-light);
      line-height: 1.4;
      font-style: italic;
    }

    .analysis-box {
      background: #FFF8E7;
      border-left: 3px solid #F5A623;
      border-radius: 0 8px 8px 0;
      padding: 12px 16px;
      font-size: 13.5px;
      color: #5C4A1E;
      line-height: 1.6;
      margin-bottom: 14px;
    }

    .analysis-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #F5A623;
      margin-bottom: 4px;
    }

    .followup-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .followup-btn {
      background: var(--white);
      border: 1.5px solid var(--border);
      border-radius: 20px;
      padding: 6px 14px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      color: var(--navy);
      cursor: pointer;
      transition: all 0.15s;
      font-weight: 500;
    }

    .followup-btn::before { content: "→ "; opacity: 0.5; }

    .followup-btn:hover {
      background: var(--navy);
      border-color: var(--navy);
      color: white;
    }

    .loading-dots {
      display: flex;
      gap: 6px;
      padding: 16px 0;
      align-items: center;
    }

    .loading-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--ink-light);
      animation: bounce 1.2s ease infinite;
    }

    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
      40% { transform: translateY(-8px); opacity: 1; }
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .error-msg { color: var(--accent); font-size: 14px; padding: 12px 0; }

    .input-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(247,246,242,0.96);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
      padding: 14px 24px 18px;
      z-index: 100;
    }

    .input-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    #user-input {
      flex: 1;
      background: var(--white);
      border: 1.5px solid var(--border);
      border-radius: 24px;
      padding: 12px 20px;
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      color: var(--ink);
      resize: none;
      min-height: 48px;
      max-height: 120px;
      line-height: 1.5;
      outline: none;
      transition: border-color 0.15s;
    }

    #user-input:focus { border-color: var(--navy); }
    #user-input::placeholder { color: var(--ink-light); }

    #send-btn {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 24px;
      padding: 12px 24px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
      height: 48px;
      white-space: nowrap;
    }

    #send-btn:hover:not(:disabled) { background: #e03333; transform: translateY(-1px); }
    #send-btn:disabled { background: var(--ink-light); cursor: not-allowed; }

    .disclaimer { font-size: 11px; color: var(--ink-light); text-align: center; margin-top: 8px; }

    .methodo-bar {
      background: #F0EFE9;
      border-bottom: 1px solid var(--border);
      padding: 0;
    }

    .methodo-toggle {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 24px;
      font-size: 12px;
      font-weight: 600;
      color: var(--ink-mid);
      cursor: pointer;
      background: none;
      border: none;
      font-family: 'DM Sans', sans-serif;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .methodo-toggle:hover { color: var(--ink); }

    .methodo-content {
      display: none;
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 24px 16px;
    }

    .methodo-content.open { display: block; }

    .methodo-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .methodo-block {
      background: white;
      border-radius: 8px;
      padding: 14px 16px;
      border: 1px solid var(--border);
    }

    .methodo-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--ink-mid);
      margin-bottom: 8px;
    }

    .methodo-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .methodo-list li {
      font-size: 12px;
      color: var(--ink-mid);
      line-height: 1.5;
      display: flex;
      gap: 6px;
    }

    .methodo-list li::before { content: "+1"; font-weight: 700; color: var(--ink-light); flex-shrink: 0; }

    @media (max-width: 700px) {
      .methodo-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 700px) {
      .header-pills { display: none; }
      main { padding: 20px 16px 140px; }
      .input-bar { padding: 10px 16px 14px; }
      .cards-grid { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 480px) {
      .cards-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div>
      <span class="logo-main">Pourquoi<span class="logo-accent">Voter</span>.fr</span>
      <span class="logo-sub">Paris 2026</span>
    </div>
    <div class="header-pills">
      <span class="pill" style="background:#E91E8C">Grégoire</span>
      <span class="pill" style="background:#1A237E">Knafo</span>
      <span class="pill" style="background:#FF8C00">Bournazel</span>
      <span class="pill" style="background:#0066CC">Dati</span>
      <span class="pill" style="background:#003189">Mariani</span>
      <span class="pill" style="background:#CC0000">Chikirou</span>
    </div>
  </div>
</header>

<div class="methodo-bar">
  <button class="methodo-toggle" onclick="toggleMethodo()">
    ℹ️ Comment sont calculés les scores ? <span id="methodo-arrow">▼</span>
  </button>
  <div class="methodo-content" id="methodo-content">
    <div class="methodo-grid">
      <div class="methodo-block">
        <div class="methodo-title">★ Concrète (0-5) — critères objectifs</div>
        <ul class="methodo-list">
          <li>Contient un chiffre précis (montant, %, nombre)</li>
          <li>Mentionne un délai ou une date</li>
          <li>Nomme un projet, lieu ou mécanisme spécifique</li>
          <li>Chiffre le coût ou le budget</li>
          <li>S'appuie sur un cadre légal existant</li>
        </ul>
      </div>
      <div class="methodo-block">
        <div class="methodo-title">★ Réaliste (0-5) — faits vérifiables</div>
        <ul class="methodo-list">
          <li>La mairie de Paris peut l'appliquer seule</li>
          <li>Coût compatible avec le budget de Paris (~10Mds€/an)</li>
          <li>Précédent dans une autre grande ville</li>
          <li>Aucune institution n'a contesté ce type de mesure</li>
          <li>Ne nécessite pas de négociation avec l'État</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<main>
  <div class="suggested-wrap" id="suggested-wrap">
    <div class="section-label">Questions fréquentes</div>
    <div class="suggested-grid" id="suggested-grid"></div>
  </div>
  <div id="conversation"></div>
</main>

<div class="input-bar">
  <div class="input-inner">
    <textarea id="user-input" rows="1" placeholder="Posez votre question sur les programmes…" maxlength="500"></textarea>
    <button id="send-btn">Envoyer →</button>
  </div>
  <p class="disclaimer">Outil neutre · Ne recommande aucun candidat · Basé sur les programmes publiés</p>
</div>

<script>
  function toggleMethodo() {
    const content = document.getElementById('methodo-content');
    const arrow = document.getElementById('methodo-arrow');
    content.classList.toggle('open');
    arrow.textContent = content.classList.contains('open') ? '▲' : '▼';
  }

  const SUGGESTED_QUESTIONS = [
    "Quelles sont les propositions sur le logement social ?",
    "Qui prévoit de baisser les impôts locaux ?",
    "Quelle est leur position sur les locations Airbnb ?",
    "Comment comptent-ils financer leur programme ?",
    "Quelles mesures pour la sécurité dans les rues ?",
    "Que proposent-ils pour les sans-abri ?",
    "Quelle place pour la voiture à Paris ?",
    "Quelles sont leurs propositions pour les cantines scolaires ?",
    "Comment abordent-ils la question des pistes cyclables ?",
    "Que prévoient-ils pour les personnes âgées et dépendantes ?",
  ];

  const API_URL = '/api/chat';
  let messages = [];
  let isLoading = false;

  const suggestedGrid = document.getElementById('suggested-grid');
  const suggestedWrap = document.getElementById('suggested-wrap');
  const conversation  = document.getElementById('conversation');
  const userInput     = document.getElementById('user-input');
  const sendBtn       = document.getElementById('send-btn');

  SUGGESTED_QUESTIONS.forEach(q => {
    const btn = document.createElement('button');
    btn.className = 'suggested-btn';
    btn.textContent = q;
    btn.addEventListener('click', () => submit(q));
    suggestedGrid.appendChild(btn);
  });

  userInput.addEventListener('input', () => {
    userInput.style.height = 'auto';
    userInput.style.height = Math.min(userInput.scrollHeight, 120) + 'px';
  });

  userInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
  });

  sendBtn.addEventListener('click', handleSend);

  function handleSend() {
    const text = userInput.value.trim();
    if (!text || isLoading) return;
    submit(text);
  }

  async function submit(text) {
    if (isLoading) return;
    suggestedWrap.style.display = 'none';

    messages.push({ role: 'user', content: text });
    appendUserMessage(text);
    userInput.value = '';
    userInput.style.height = 'auto';
    isLoading = true;
    sendBtn.disabled = true;

    const loadingEl = appendLoading();

    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages }),
      });

      if (!response.ok) throw new Error('HTTP ' + response.status);

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let fullText = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value);
        for (const line of chunk.split('\n')) {
          if (!line.startsWith('data: ')) continue;
          const data = line.slice(6).trim();
          if (data === '[DONE]') break;
          let parsed = null;
          try { parsed = JSON.parse(data); } catch {}
          if (parsed) {
            if (parsed.text) fullText += parsed.text;
            if (parsed.error) throw new Error(parsed.error);
          }
        }
      }

      loadingEl.remove();
      console.log('=== BRUT ===', fullText.slice(0, 300));
      const jsonData = parseJSON('{' + fullText);
      if (jsonData) {
        renderResponse(jsonData);
        messages.push({ role: 'assistant', content: '{' + fullText });
      } else {
        appendError("La réponse n'a pas pu être analysée. Réessayez.");
      }

    } catch (err) {
      loadingEl.remove();
      appendError("Une erreur est survenue. Réessayez.");
      console.error(err);
    } finally {
      isLoading = false;
      sendBtn.disabled = false;
      userInput.focus();
    }
  }

  function parseJSON(text) {
    try {
      const clean = text.replace(/^```json\s*/i, '').replace(/```\s*$/i, '').trim();
      return JSON.parse(clean);
    } catch {
      const match = text.match(/\{[\s\S]*\}/);
      if (match) { try { return JSON.parse(match[0]); } catch {} }
      return null;
    }
  }

  function renderResponse(data) {
    const el = document.createElement('div');
    el.className = 'assistant-message';
    let html = '';

    if (data.intro) {
      html += `<div class="response-intro">${esc(data.intro)}</div>`;
    }

    if (data.candidates && data.candidates.length) {
      html += '<div class="cards-grid">';
      for (const c of data.candidates) {
        const score = Math.min(10, Math.max(0, c.score || 0));
        html += `
          <div class="candidate-card">
            <div class="card-header" style="background:${esc(c.color||'#333')}">
              <div>
                <div class="card-name">${esc(c.name||'')}</div>
                <div class="card-party">${esc(c.party||'')}</div>
              </div>
              <div class="card-score-circle">${score}</div>
            </div>
            <div class="card-body">
              ${c.highlight ? `<span class="card-highlight">${esc(c.highlight)}</span>` : ''}
              <div class="card-position">${esc(c.position||'')}</div>
              <div class="card-indicators">
                <div class="card-indicator-row">
                  <div class="card-indicator-label">
                    <span>Concrète</span>
                    <span class="card-stars">${stars(c.concrete, 5)}</span>
                  </div>
                  ${c.concrete_detail ? `<div class="card-indicator-detail">${esc(c.concrete_detail)}</div>` : ''}
                </div>
                <div class="card-indicator-row">
                  <div class="card-indicator-label">
                    <span>Réaliste</span>
                    <span class="card-stars">${stars(c.realiste, 5)}</span>
                  </div>
                  ${c.realiste_detail ? `<div class="card-indicator-detail">${esc(c.realiste_detail)}</div>` : ''}
                </div>
              </div>
            </div>
          </div>`;
      }
      html += '</div>';
    }

    if (data.analysis) {
      html += `<div class="analysis-box"><div class="analysis-label">⚡ Analyse factuelle</div>${esc(data.analysis)}</div>`;
    }

    if (data.followup && data.followup.length) {
      html += '<div class="followup-wrap">';
      for (const q of data.followup) {
        html += `<button class="followup-btn" data-q="${esc(q)}">${esc(q)}</button>`;
      }
      html += '</div>';
    }

    el.innerHTML = html;

    el.querySelectorAll('.followup-btn').forEach(btn => {
      btn.addEventListener('click', () => submit(btn.dataset.q));
    });

    conversation.appendChild(el);
    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function appendUserMessage(text) {
    const el = document.createElement('div');
    el.className = 'user-message';
    el.innerHTML = `<div class="user-bubble">${esc(text)}</div>`;
    conversation.appendChild(el);
    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function appendLoading() {
    const el = document.createElement('div');
    el.className = 'assistant-message';
    el.innerHTML = `<div class="loading-dots"><span></span><span></span><span></span></div>`;
    conversation.appendChild(el);
    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    return el;
  }

  function appendError(msg) {
    const el = document.createElement('div');
    el.className = 'assistant-message';
    el.innerHTML = `<div class="error-msg">⚠️ ${esc(msg)}</div>`;
    conversation.appendChild(el);
  }

  function esc(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function stars(val, max) {
    const n = Math.min(max, Math.max(0, Math.round(val || 0)));
    return '★'.repeat(n) + '☆'.repeat(max - n);
  }
</script>
</body>
</html>
